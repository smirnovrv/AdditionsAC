
&ИзменениеИКонтроль("ПередЗаписью")
Процедура АЛФ_ПередЗаписью(Отказ)

	Если ОбменДанными.Загрузка  Тогда
		Возврат;
	КонецЕсли;  
	
#Вставка     
	Если ПометкаУдаления И Не Проект И Не ЗначениеЗаполнено(Родитель) Тогда
		//Проект = Истина;
	КонецЕсли;
#КонецВставки
#Удаление
	// Если это этап верхнего уровня, то преобразуем его в отдельный проект.
	Если НЕ (Проект ИЛИ ЗначениеЗаполнено(Родитель)) Тогда	
		Проект = Истина;	
	КонецЕсли;
    
	// Для верхнего уровня всегда установим признак, что это проект, а не этап
	Если НЕ Проект И Не ЗначениеЗаполнено(Родитель) Тогда
		Проект = Истина;
	КонецЕсли;	

	// Для если проект пытемся переместить на уровень>1, то принудительно делаем его этапом.

	Если Проект И  ЗначениеЗаполнено(Родитель) Тогда
		Проект = Ложь;
	КонецЕсли;
#КонецУдаления
	Если Проект Тогда

		Если ЭтоНовый() Тогда
			УстановитьСсылкуНового(Справочники.Проекты.ПолучитьСсылку());
			ПроектЭтапа = ПолучитьСсылкуНового();
		Иначе
			ПроектЭтапа = Ссылка;
		КонецЕсли;

	Иначе

		ТекущийРодитель=Родитель;

		Пока Истина Цикл

			Если НЕ ЗначениеЗаполнено(ТекущийРодитель) Тогда

				ПроектЭтапа=Справочники.Проекты.ПустаяСсылка();
				Прервать;

			ИначеЕсли ТекущийРодитель.Проект Тогда

				ПроектЭтапа= ТекущийРодитель;
				Прервать;

			Иначе

				ТекущийРодитель=ТекущийРодитель.Родитель;

			КонецЕсли;

		КонецЦикла;	

	КонецЕсли;

КонецПроцедуры
